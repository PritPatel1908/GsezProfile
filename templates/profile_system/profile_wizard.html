{% extends 'base.html' %}
{% load static %}

{% block title %}Create Your Profile{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Create Profile</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i> Create Your Profile
                    </h4>
                    {% if request.user.is_staff or request.user.user_role %}
                    <div class="mt-2">
                        <a href="{% url 'skip_profile' %}" class="btn btn-light btn-sm">Skip Profile Creation (Admin Only)</a>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <div class="progress mb-4">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" 
                             id="profile-progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    
                    <form method="POST" enctype="multipart/form-data" id="profile-wizard-form">
                        {% csrf_token %}
                        
                        <!-- Step 1: Basic Profile Information -->
                        <div class="step" id="step-1">
                            <h5 class="mb-3">Basic Information</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.gsez_id.id_for_label }}" class="form-label">GSEZ ID</label>
                                    {{ form.gsez_id }}
                                    {% if form.gsez_id.errors %}
                                    <div class="text-danger">{{ form.gsez_id.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.nationality.id_for_label }}" class="form-label">Nationality</label>
                                    {{ form.nationality }}
                                    {% if form.nationality.errors %}
                                    <div class="text-danger">{{ form.nationality.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth</label>
                                    {{ form.date_of_birth }}
                                    {% if form.date_of_birth.errors %}
                                    <div class="text-danger">{{ form.date_of_birth.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.expiry_date.id_for_label }}" class="form-label">Expiry Date</label>
                                    {{ form.expiry_date }}
                                    {% if form.expiry_date.errors %}
                                    <div class="text-danger">{{ form.expiry_date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.govt_id_number.id_for_label }}" class="form-label">Government ID Number</label>
                                    {{ form.govt_id_number }}
                                    {% if form.govt_id_number.errors %}
                                    <div class="text-danger">{{ form.govt_id_number.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.emergency_contact.id_for_label }}" class="form-label">Emergency Contact</label>
                                    {{ form.emergency_contact }}
                                    {% if form.emergency_contact.errors %}
                                    <div class="text-danger">{{ form.emergency_contact.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Documents Upload -->
                        <div class="step" id="step-2" style="display: none;">
                            <h5 class="mb-3">Document Upload</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.photo.id_for_label }}" class="form-label">Profile Photo</label>
                                    {{ form.photo }}
                                    {% if form.photo.errors %}
                                    <div class="text-danger">{{ form.photo.errors }}</div>
                                    {% endif %}
                                    <div class="mt-2" id="photo-preview"></div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.govt_id_scan.id_for_label }}" class="form-label">Government ID Scan</label>
                                    {{ form.govt_id_scan }}
                                    {% if form.govt_id_scan.errors %}
                                    <div class="text-danger">{{ form.govt_id_scan.errors }}</div>
                                    {% endif %}
                                    <div class="mt-2" id="id-preview"></div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                                <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Family Details -->
                        <div class="step" id="step-3" style="display: none;">
                            <h5 class="mb-3">Family Details</h5>
                            <div id="family-details-container">
                                <div class="family-detail-form mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Name</label>
                                            <input type="text" name="family_name[]" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Relationship</label>
                                            <input type="text" name="family_relationship[]" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Contact</label>
                                            <input type="text" name="family_contact[]" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-info mb-3" id="add-family-member">
                                <i class="fas fa-plus"></i> Add Family Member
                            </button>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                                <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Address Information -->
                        <div class="step" id="step-4" style="display: none;">
                            <h5 class="mb-3">Current Address</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Address Line 1</label>
                                    <input type="text" name="address_line1" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Address Line 2</label>
                                    <input type="text" name="address_line2" class="form-control">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">City</label>
                                    <input type="text" name="city" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">State</label>
                                    <input type="text" name="state" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Country</label>
                                    <input type="text" name="country" class="form-control" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" name="postal_code" class="form-control" required>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="has-permanent-address">
                                        <label class="form-check-label" for="has-permanent-address">
                                            I have a different permanent address
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="permanent-address" style="display: none;">
                                <h5 class="mb-3">Permanent Address</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Address Line 1</label>
                                        <input type="text" name="permanent_address_line1" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Address Line 2</label>
                                        <input type="text" name="permanent_address_line2" class="form-control">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">City</label>
                                        <input type="text" name="permanent_city" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">State</label>
                                        <input type="text" name="permanent_state" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Country</label>
                                        <input type="text" name="permanent_country" class="form-control">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Postal Code</label>
                                        <input type="text" name="permanent_postal_code" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                                <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 5: Education -->
                        <div class="step" id="step-5" style="display: none;">
                            <h5 class="mb-3">Education</h5>
                            <div id="education-container">
                                <div class="education-form mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Qualification</label>
                                            <input type="text" name="qualification[]" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Institution</label>
                                            <input type="text" name="institution[]" class="form-control" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Year of Passing</label>
                                            <input type="number" name="year_of_passing[]" class="form-control" min="1900" max="2100" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-info mb-3" id="add-education">
                                <i class="fas fa-plus"></i> Add Education
                            </button>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                                <button type="button" class="btn btn-primary next-step">Next <i class="fas fa-arrow-right ms-1"></i></button>
                            </div>
                        </div>
                        
                        <!-- Step 6: Employment -->
                        <div class="step" id="step-6" style="display: none;">
                            <h5 class="mb-3">Employment Details</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Company</label>
                                    <select name="company" class="form-select" required>
                                        <option value="">Select Company</option>
                                        {% for company in companies %}
                                        <option value="{{ company.id }}">{{ company.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Employee Code</label>
                                    <input type="text" name="employee_code" class="form-control" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Designation</label>
                                    <input type="text" name="designation" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Department</label>
                                    <input type="text" name="department" class="form-control" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Join Date</label>
                                    <input type="date" name="join_date" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Date</label>
                                    <input type="date" name="end_date" class="form-control">
                                    <small class="text-muted">Leave blank if currently employed</small>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="is_current" id="is-current" checked>
                                <label class="form-check-label" for="is-current">
                                    This is my current employment
                                </label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Remarks</label>
                                <textarea name="remarks" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary prev-step"><i class="fas fa-arrow-left me-1"></i> Previous</button>
                                <button type="submit" class="btn btn-success"><i class="fas fa-check me-1"></i> Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Progress bar and step navigation
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('profile-progress');
        let currentStep = 0;
        
        // Update progress bar
        function updateProgress() {
            const progress = ((currentStep) / (steps.length - 1)) * 100;
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        }
        
        // Show current step
        function showStep(stepIndex) {
            steps.forEach((step, index) => {
                step.style.display = index === stepIndex ? 'block' : 'none';
            });
            currentStep = stepIndex;
            updateProgress();
        }
        
        // Next step buttons
        document.querySelectorAll('.next-step').forEach(button => {
            button.addEventListener('click', function() {
                // Simple validation for current step
                const currentStepElement = steps[currentStep];
                const requiredFields = currentStepElement.querySelectorAll('input[required], select[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value) {
                        isValid = false;
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                if (isValid) {
                    showStep(currentStep + 1);
                }
            });
        });
        
        // Previous step buttons
        document.querySelectorAll('.prev-step').forEach(button => {
            button.addEventListener('click', function() {
                showStep(currentStep - 1);
            });
        });
        
        // Add family member button
        document.getElementById('add-family-member').addEventListener('click', function() {
            const container = document.getElementById('family-details-container');
            const template = container.querySelector('.family-detail-form').cloneNode(true);
            
            // Clear input values
            template.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            
            // Add remove button if it's not the first one
            if (container.querySelectorAll('.family-detail-form').length > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm mt-2';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
                removeBtn.onclick = function() {
                    container.removeChild(template);
                };
                template.appendChild(removeBtn);
            }
            
            container.appendChild(template);
        });
        
        // Add education button
        document.getElementById('add-education').addEventListener('click', function() {
            const container = document.getElementById('education-container');
            const template = container.querySelector('.education-form').cloneNode(true);
            
            // Clear input values
            template.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            
            // Add remove button if it's not the first one
            if (container.querySelectorAll('.education-form').length > 0) {
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-danger btn-sm mt-2';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
                removeBtn.onclick = function() {
                    container.removeChild(template);
                };
                template.appendChild(removeBtn);
            }
            
            container.appendChild(template);
        });
        
        // Toggle permanent address section
        document.getElementById('has-permanent-address').addEventListener('change', function() {
            document.getElementById('permanent-address').style.display = this.checked ? 'block' : 'none';
        });
        
        // Toggle end date field based on current employment status
        document.getElementById('is-current').addEventListener('change', function() {
            const endDateInput = document.querySelector('input[name="end_date"]');
            endDateInput.required = !this.checked;
            endDateInput.disabled = this.checked;
            if (this.checked) {
                endDateInput.value = '';
            }
        });
        
        // Image preview for photo upload
        document.querySelector('input[name="photo"]').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-thumbnail';
                    img.style.maxHeight = '150px';
                    const previewDiv = document.getElementById('photo-preview');
                    previewDiv.innerHTML = '';
                    previewDiv.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Image preview for ID scan upload
        document.querySelector('input[name="govt_id_scan"]').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-thumbnail';
                    img.style.maxHeight = '150px';
                    const previewDiv = document.getElementById('id-preview');
                    previewDiv.innerHTML = '';
                    previewDiv.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Initialize first step
        showStep(0);
    });
</script>
{% endblock %}
{% endblock %} 